import pandas as pd  # å¯¼å…¥pandasåº“ï¼Œå¹¶ä½¿ç”¨pdä½œä¸ºåˆ«åï¼Œè¿™æ˜¯ä¸€ä¸ªå¹¿æ³›æ¥å—çš„æƒ¯ä¾‹ã€‚
# pandasåº“æ˜¯Pythonä¸­ç”¨äºæ•°æ®åˆ†æçš„æ ¸å¿ƒåº“ï¼Œå®ƒæä¾›äº†DataFrameè¿™ä¸ªå¼ºå¤§çš„æ•°æ®ç»“æ„ã€‚
# å¯å¤„ç†å¤šç§æ ¼å¼çš„æ•°æ®æ–‡ä»¶ï¼ŒåŒ…æ‹¬Excelã€CSVã€SQLç­‰ã€‚
import sys  # å¯¼å…¥sysæ¨¡å—ï¼Œç”¨äºè®¿é—®å‘½ä»¤è¡Œå‚æ•°ã€‚
import os  # å¯¼å…¥osæ¨¡å—ï¼Œç”¨äºå¤„ç†æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œã€‚

def parse_arguments():
    """
    åŠŸèƒ½: è§£æå’ŒéªŒè¯å‘½ä»¤è¡Œå‚æ•°ã€‚
    - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æä¾›äº†æ–‡ä»¶è·¯å¾„ã€‚
    - è§£æå¯é€‰çš„Sheetåæˆ–ç´¢å¼•ã€‚
    - éªŒè¯æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨ä¸”ä¸ºæ–‡ä»¶ã€‚
    è¿”å›: ä¸€ä¸ªå…ƒç»„ (input_excel_path, sheet_to_read, sheet_display_name)ã€‚
    """
    # æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°çš„æ•°é‡ã€‚sys.argv[0] æ˜¯è„šæœ¬æœ¬èº«çš„åç§°ã€‚
    # sys.argv[1] æ˜¯ç”¨æˆ·è¾“å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆæ–‡ä»¶è·¯å¾„ï¼‰ã€‚
    # sys.argv[2] æ˜¯ç”¨æˆ·è¾“å…¥çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯é€‰çš„Sheetåæˆ–ç´¢å¼•ï¼‰ã€‚
    if len(sys.argv) < 2:
        # å¦‚æœç”¨æˆ·æ²¡æœ‰æä¾›æ–‡ä»¶è·¯å¾„ï¼Œæ‰“å°ä½¿ç”¨è¯´æ˜å¹¶é€€å‡ºç¨‹åºã€‚
        print("âŒ é”™è¯¯ï¼šè¯·åœ¨å‘½ä»¤è¡Œä¸­æä¾›è¦å¤„ç†çš„Excelæ–‡ä»¶è·¯å¾„ã€‚")
        print("ç”¨æ³•ç¤ºä¾‹ï¼š")
        print("  python excel_process.py <ä½ çš„Excelæ–‡ä»¶è·¯å¾„>")
        print("  python excel_process.py <ä½ çš„Excelæ–‡ä»¶è·¯å¾„> <Sheetåç§°æˆ–ç´¢å¼•>")
        sys.exit(1) # ä½¿ç”¨éé›¶çŠ¶æ€ç é€€å‡ºï¼Œè¡¨ç¤ºç¨‹åºå¼‚å¸¸ç»ˆæ­¢ã€‚

    # è·å–ç”¨æˆ·è¾“å…¥çš„Excelæ–‡ä»¶è·¯å¾„ã€‚
    input_excel_path = sys.argv[1]

    # ç¡®å®šè¦è¯»å–çš„Sheetã€‚
    # é»˜è®¤è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨ï¼ˆç´¢å¼•ä¸º0ï¼‰ã€‚
    sheet_to_read = 0
    sheet_display_name = "ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨ (ç´¢å¼• 0)" # ç”¨äºæ‰“å°è¾“å‡ºçš„å‹å¥½åç§°

    if len(sys.argv) > 2:
        # å¦‚æœç”¨æˆ·æä¾›äº†ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå°è¯•å°†å…¶ä½œä¸ºSheetåæˆ–ç´¢å¼•ã€‚
        sheet_arg = sys.argv[2]
        try:
            # å°è¯•å°†å‚æ•°è½¬æ¢ä¸ºæ•´æ•°ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è®¤ä¸ºæ˜¯Sheetç´¢å¼•ã€‚
            sheet_to_read = int(sheet_arg)
            sheet_display_name = f"ç´¢å¼• {sheet_to_read}"
        except ValueError:
            # å¦‚æœè½¬æ¢å¤±è´¥ï¼Œåˆ™è®¤ä¸ºæ˜¯Sheetåç§°ã€‚
            sheet_to_read = sheet_arg
            sheet_display_name = f"åç§° '{sheet_to_read}'"
        
        if len(sys.argv) > 3:
            print("âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°å¤šä½™çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œå°†åªä½¿ç”¨å‰ä¸¤ä¸ªå‚æ•°ï¼ˆæ–‡ä»¶è·¯å¾„å’Œå¯é€‰çš„Sheetå/ç´¢å¼•ï¼‰ã€‚")

    # éªŒè¯æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨ã€‚
    if not os.path.exists(input_excel_path):
        print(f"âŒ é”™è¯¯ï¼šæ–‡ä»¶ä¸å­˜åœ¨ -> '{input_excel_path}'")
        sys.exit(1)

    # éªŒè¯è·¯å¾„æ˜¯å¦ç¡®å®æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç›®å½•ã€‚
    if not os.path.isfile(input_excel_path):
        print(f"âŒ é”™è¯¯ï¼šæä¾›çš„è·¯å¾„ä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€ä¸ªç›®å½• -> '{input_excel_path}'")
        sys.exit(1)
        
    return input_excel_path, sheet_to_read, sheet_display_name

def read_excel_data(file_path, sheet_name, sheet_display_name):
    """
    åŠŸèƒ½: ä»æŒ‡å®šçš„Excelæ–‡ä»¶å’Œå·¥ä½œè¡¨ä¸­è¯»å–æ•°æ®ã€‚
    å‚æ•°:
        - file_path: Excelæ–‡ä»¶è·¯å¾„ã€‚
        - sheet_name: è¦è¯»å–çš„å·¥ä½œè¡¨åç§°æˆ–ç´¢å¼•ã€‚
        - sheet_display_name: ç”¨äºæ‰“å°ä¿¡æ¯çš„å‹å¥½åç§°ã€‚
    è¿”å›: ä¸€ä¸ªpandas DataFrameå¯¹è±¡ã€‚
    """
    # pd.read_excel() æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè¯»å–Excelæ–‡ä»¶ã€‚
    # è¿™è¡Œä»£ç çš„æ‰§è¡Œç»“æœæ˜¯åˆ›å»ºä¸€ä¸ªDataFrameå¯¹è±¡ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆå†…å­˜ä¸­çš„ä¸€ä¸ªExcelè¡¨æ ¼ã€‚
    try: 
        df = pd.read_excel(file_path, sheet_name=sheet_name)
        print(f"âœ… æˆåŠŸè¯»å–æ–‡ä»¶ï¼š'{file_path}' ä¸­çš„ {sheet_display_name} å·¥ä½œè¡¨ã€‚")
        return df
    except ValueError as ve:
        # æ•è·å½“æŒ‡å®šçš„sheet_nameä¸å­˜åœ¨æ—¶å¯èƒ½æŠ›å‡ºçš„ValueErrorã€‚
        print(f"âŒ é”™è¯¯ï¼šåœ¨æ–‡ä»¶ '{file_path}' ä¸­æœªæ‰¾åˆ°æŒ‡å®šçš„ {sheet_display_name} å·¥ä½œè¡¨ã€‚")
        print(f"è¯·æ£€æŸ¥Sheetåç§°æˆ–ç´¢å¼•æ˜¯å¦æ­£ç¡®ã€‚è¯¦ç»†é”™è¯¯ï¼š{ve}")
        sys.exit(1)
    except FileNotFoundError:
        # å°½ç®¡å‰é¢å·²ç»æ£€æŸ¥è¿‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä½†ä¸ºäº†å¥å£®æ€§ï¼Œè¿™é‡Œå†æ¬¡æ•è·ã€‚
        print(f"âŒ é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°æ–‡ä»¶ '{file_path}'ã€‚")
        sys.exit(1)
    except Exception as e:
        # æ•è·å…¶ä»–å¯èƒ½çš„è¯»å–é”™è¯¯ï¼Œä¾‹å¦‚æ–‡ä»¶æŸåã€æ ¼å¼ä¸æ­£ç¡®ç­‰ã€‚
        print(f"âŒ é”™è¯¯ï¼šè¯»å–Excelæ–‡ä»¶ '{file_path}' æ—¶å‘ç”Ÿé—®é¢˜ï¼š{e}")
        sys.exit(1)

def process_duplicate_rows(df):
    """
    åŠŸèƒ½: å®ç°æ ¸å¿ƒä¸šåŠ¡é€»è¾‘â€”â€”æ ¹æ®"æ–°å¢è®°å½•"åˆ—çš„å€¼å¤åˆ¶è¡Œã€‚
    å‚æ•°:
        - df: åŸå§‹çš„DataFrameã€‚
    è¿”å›: ä¸€ä¸ªå¤„ç†è¿‡ï¼ˆå¤åˆ¶äº†è¡Œï¼‰çš„æ–°DataFrameã€‚
    """
    # åˆ›å»ºä¸€ä¸ªç©ºçš„Pythonåˆ—è¡¨ï¼Œå‘½åä¸ºprocessed_rowsã€‚
    # æˆ‘ä»¬å°†ç”¨è¿™ä¸ªåˆ—è¡¨æ¥æ”¶é›†æ‰€æœ‰çš„è¡Œï¼ŒåŒ…æ‹¬åŸå§‹è¡Œå’Œéœ€è¦å¤åˆ¶çš„æ–°è¡Œã€‚
    processed_rows = []

    # df.iterrows() æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ–¹æ³•ï¼Œå®ƒä¼šé€è¡Œéå†DataFrame (df)ã€‚
    # åœ¨æ¯ä¸€æ¬¡å¾ªç¯ä¸­ï¼Œå®ƒä¼šè¿”å›ä¸¤ä¸ªå€¼ï¼š
    # - index: å½“å‰è¡Œçš„è¡Œæ ‡ç­¾ï¼ˆæˆ–è¡Œå·ï¼‰ï¼Œé»˜è®¤ä»0å¼€å§‹ã€‚
    # - row: ä¸€ä¸ªåŒ…å«å½“å‰è¡Œæ‰€æœ‰æ•°æ®çš„Serieså¯¹è±¡ã€‚ä½ å¯ä»¥é€šè¿‡åˆ—åä»rowä¸­è·å–å•å…ƒæ ¼çš„å€¼ã€‚
    for index, row in df.iterrows():
        # æ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬éƒ½å¸Œæœ›ä¿ç•™åŸå§‹çš„æ¯ä¸€è¡Œæ•°æ®ï¼Œæ‰€ä»¥å…ˆæŠŠå½“å‰è¡Œ(row)æ·»åŠ åˆ°æˆ‘ä»¬çš„ç»“æœåˆ—è¡¨(processed_rows)ä¸­ã€‚
        processed_rows.append(row)
        
        # --- æ ¸å¿ƒé€»è¾‘ï¼šæ ¹æ®"æ–°å¢è®°å½•"åˆ—çš„å€¼æ¥å¤åˆ¶è¡Œ ---
        # row.get('æ–°å¢è®°å½•', 0) ä»å½“å‰è¡Œ(row)ä¸­è·å–'æ–°å¢è®°å½•'è¿™ä¸€åˆ—çš„å€¼ã€‚
        # ä½¿ç”¨ .get() æ–¹æ³•çš„å¥½å¤„æ˜¯ï¼Œå¦‚æœ'æ–°å¢è®°å½•'è¿™ä¸€åˆ—ä¸å­˜åœ¨ï¼Œæˆ–è€…è¯¥å•å…ƒæ ¼ä¸ºç©ºï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªé»˜è®¤å€¼0ï¼Œè€Œä¸æ˜¯æŠ¥é”™ã€‚
        add_num = row.get('æ–°å¢è®°å½•', 0)

        # pd.notnull(add_num) ç”¨æ¥æ£€æŸ¥æˆ‘ä»¬è·å–åˆ°çš„å€¼æ˜¯å¦æ˜¯æœ‰æ•ˆå€¼ï¼ˆä¸æ˜¯ç©ºå€¼NaNï¼‰ã€‚
        if pd.notnull(add_num):
            try:
                # å°è¯•å°†è·å–åˆ°çš„å€¼è½¬æ¢ä¸ºæ•´æ•°ã€‚å¦‚æœè¿™ä¸€æ ¼é‡Œæ˜¯æ–‡æœ¬ï¼ˆæ¯”å¦‚"abc"ï¼‰ï¼Œè½¬æ¢ä¼šå¤±è´¥ï¼Œå¹¶è§¦å‘exceptã€‚
                add_num = int(add_num)
                # åªæœ‰å½“éœ€è¦æ–°å¢çš„è®°å½•æ•°å¤§äº0æ—¶ï¼Œæ‰æ‰§è¡Œå¤åˆ¶æ“ä½œã€‚
                if add_num > 0:
                    # ä½¿ç”¨ for å¾ªç¯æ¥ç²¾ç¡®åœ°å¤åˆ¶æŒ‡å®šçš„æ¬¡æ•°ã€‚
                    # æ¯”å¦‚ï¼Œå¦‚æœ add_num æ˜¯ 2ï¼Œè¿™ä¸ªå¾ªç¯å°±ä¼šæ‰§è¡Œ 2 æ¬¡ã€‚
                    for _ in range(add_num):
                        # åœ¨å¾ªç¯ä¸­ï¼ŒæŠŠå½“å‰è¡Œ(row)å†æ¬¡æ·»åŠ åˆ°ç»“æœåˆ—è¡¨ä¸­ã€‚
                        processed_rows.append(row)
            except (ValueError, TypeError):
                # å¦‚æœint()è½¬æ¢å¤±è´¥ï¼ˆä¾‹å¦‚ï¼Œå€¼æ˜¯æ–‡æœ¬æˆ–æ— æ³•è½¬æ¢çš„æ ¼å¼ï¼‰ï¼Œç¨‹åºä¼šè·³è½¬åˆ°è¿™é‡Œã€‚
                # pass è¯­å¥è¡¨ç¤ºä»€ä¹ˆä¹Ÿä¸åšï¼Œç›´æ¥å¿½ç•¥è¿™ä¸ªé”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œã€‚
                pass
    
    # å½“æ‰€æœ‰è¡Œéƒ½å¤„ç†å®Œæ¯•åï¼Œprocessed_rowsåˆ—è¡¨é‡Œå°±åŒ…å«äº†æ‰€æœ‰åŸå§‹è¡Œå’Œè¢«å¤åˆ¶çš„æ–°è¡Œã€‚
    # pd.DataFrame(processed_rows) ä¼šä½¿ç”¨è¿™ä¸ªåˆ—è¡¨æ¥åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„DataFrameã€‚
    # .reset_index(drop=True) ä¼šä¸ºæ–°çš„DataFrameç”Ÿæˆä¸€ä¸ªå¹²å‡€çš„ã€ä»0å¼€å§‹çš„è¿ç»­ç´¢å¼•ï¼Œå¹¶ä¸¢å¼ƒæ—§çš„ç´¢å¼•ã€‚
    result_df = pd.DataFrame(processed_rows).reset_index(drop=True)
    return result_df

def save_dataframe_to_excel(df, original_input_path):
    """
    åŠŸèƒ½: å°†æœ€ç»ˆçš„DataFrameä¿å­˜åˆ°æ–°çš„Excelæ–‡ä»¶ä¸­ã€‚
    - æ ¹æ®åŸå§‹è¾“å…¥è·¯å¾„è‡ªåŠ¨ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åã€‚
    å‚æ•°:
        - df: è¦ä¿å­˜çš„DataFrameã€‚
        - original_input_path: åŸå§‹è¾“å…¥æ–‡ä»¶çš„è·¯å¾„ï¼Œç”¨äºç”Ÿæˆè¾“å‡ºæ–‡ä»¶åã€‚
    """
    # è·å–è¾“å…¥æ–‡ä»¶çš„ç›®å½•ã€‚
    input_dir = os.path.dirname(original_input_path)
    # è·å–è¾“å…¥æ–‡ä»¶çš„åŸºæœ¬åç§°ï¼ˆä¸åŒ…å«ç›®å½•ï¼‰ã€‚
    input_filename = os.path.basename(original_input_path)
    # åˆ†ç¦»æ–‡ä»¶åå’Œæ‰©å±•åã€‚
    name, ext = os.path.splitext(input_filename)
    # æ„é€ æ–°çš„è¾“å‡ºæ–‡ä»¶åï¼Œä¾‹å¦‚ 'åŸå§‹æ–‡ä»¶å_processed.xlsx'ã€‚
    output_filename = f"{name}_processed{ext}"
    # ç»„åˆç›®å½•å’Œæ–°çš„æ–‡ä»¶åï¼Œå½¢æˆå®Œæ•´çš„è¾“å‡ºæ–‡ä»¶è·¯å¾„ã€‚
    output_excel_path = os.path.join(input_dir, output_filename)

    # å°†æœ€ç»ˆå¤„ç†å¥½çš„DataFrame (df) ä¿å­˜åˆ°ä¸€ä¸ªæ–°çš„Excelæ–‡ä»¶ä¸­ã€‚
    # index=False å‚æ•°å‘Šè¯‰pandasåœ¨ä¿å­˜æ—¶ï¼Œä¸è¦æŠŠDataFrameçš„è¡Œç´¢å¼•ï¼ˆ0, 1, 2...ï¼‰ä¹Ÿå†™åˆ°Excelæ–‡ä»¶é‡Œï¼Œè¿™é€šå¸¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚
    df.to_excel(output_excel_path, index=False)

    print(f"ğŸ‰ å¤„ç†å®Œæˆï¼ç»“æœå·²ä¿å­˜åˆ°ï¼š'{output_excel_path}'")

def main():
    """
    ä¸»å‡½æ•°ï¼Œç¨‹åºçš„æ€»å…¥å£å’Œè°ƒåº¦ä¸­å¿ƒã€‚
    """
    # 1. è§£æå‘½ä»¤è¡Œå‚æ•°
    input_path, sheet, sheet_name_for_print = parse_arguments()
    
    # 2. è¯»å–Excelæ•°æ®
    original_df = read_excel_data(input_path, sheet, sheet_name_for_print)
    
    # 3. æ‰§è¡Œæ ¸å¿ƒå¤„ç†é€»è¾‘
    processed_df = process_duplicate_rows(original_df)
    
    # 4. ä¿å­˜å¤„ç†ç»“æœ
    save_dataframe_to_excel(processed_df, input_path)

if __name__ == "__main__":
    main()